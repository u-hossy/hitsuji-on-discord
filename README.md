# ひつじ on Discord

自分のための便利 Discord Bot

## 機能

### スラッシュコマンド

以下の表に示すスラッシュコマンドを利用することができます。

| コマンド                   | 説明                                                                                                          |
| :------------------------- | :------------------------------------------------------------------------------------------------------------ |
| `generate-ideas-gemini`    | Gemini が送信されたメッセージをもとにアイディアを生成します。                                                 |
| `get-book-info`            | ISBN コードから書籍の情報を返します。                                                                         |
| `hitsuji`                  | 「やっほー！あなただけの**ひつじ**だよ！」と言ってくれます。                                                  |
| `hitsuji-channel-info`     | チャンネル名とチャンネル ID を返します。                                                                      |
| `summarize-article-gemini` | Gemini が与えられたリンク先の内容を要約します。                                                               |
| `summarize-gemini`         | Gemini が送信されたメッセージを要約します。要約対象はこのコマンドが使用されたチャンネルあるいはスレッドです。 |

### AI チャット

特定のチャンネルに送信されたメッセージに対して、大規模言語モデル（現状 Gemini のみ対応）が返信してくれます。

### 校正

特定のチャンネルに送信されたメッセージを [textlint](https://textlint.org/) で校正します。

## デプロイ方法

> [!NOTE]
> ここでは`pnpm`を利用したデプロイ方法を記載しています。別に`npm`や`yarn`でも動作すると思いますので、こだわりがある方は適宜読みかえてください。

### 依存関係のインストール

依存関係を以下のコマンドを用いてインストールしてください。

```bash
pnpm install
```

### 環境変数ファイルの準備

環境変数を記述する 3 つのファイルを以下の`cp`コマンドで準備してください。

```bash
cp .env.example .env
cp gemini.config.example.json gemini.config.json
cp textlint.config.example.json textlint.config.json
```

### アプリケーションの作成とインストール

#### アプリケーションの作成

[Discord Developer Portal](https://discord.com/developers/applications/) からアプリケーションを作成してください。

#### アプリケーションの設定の変更

まずは作成したアプリケーションを選択し、Installation のページに移動してください。

`Default Install Settings`の`Guild Install`の`Scopes`に`Bot`を追加し、`Permissions`に以下の権限を渡します。

> めんどくさければ`Administrator`を渡せば解決する話ではありますが、不要な権限も渡すこととなるのでおすすめはできないです。
> 少なくとも心理的なハードルがある人は以下の権限を選んで渡すことを推奨します。

- `Read Message History`
- `Send Messages`
- `Send Messages in Threads`

次に Bots のページに移動し、`Message Content Intent`の設定を有効化します。送られたメッセージを Bot が自発的に読めるようになります。

> つまり特定のチャンネルで返答してくれる系の機能を使いたいなら有効にする必要があります。

#### サーバーへアプリケーションをインストールする

先ほどの Installation のページに移動して、`Install Link`をコピーして、ブラウザに貼り付けてください。

そうすれば Bot をインストールする画面になるので、あとは画面の指示に従ってインストールしてください。

### 環境変数の設定

先ほど`cp`コマンドで作成した環境変数ファイルの設定をそれぞれ行ってください。

#### `.env`

API キーなどを主に認証情報を設定するファイルです。以下の表のように各項目を変更してください。

| 変数名              | 説明                                                                                                                                             |
| :------------------ | :----------------------------------------------------------------------------------------------------------------------------------------------- |
| APP_MODE            | 本番モードか開発モードかを指定します。本番モードにするなら`production`、開発モードなら`debug`と設定してください。                                |
| DISCORD_CLINETID    | Developer Portal の General Information のページから取得できる `Application ID` を設定してください。                                             |
| DISCORD_GUILDID     | サーバー ID をここに設定してください。開発者モードが有効になっていれば、サーバーのアイコンを右クリックして表示されるメニューからコピーできます。 |
| DISCORD_TOKEN       | Developer Portal の Bot のページから取得できるトークンを設定してください。                                                                       |
| GOOGLE_GENAI_APIKEY | [このページ](https://aistudio.google.com/api-keys)から取得できる Gemini の API キーを設定してください。                                          |

#### `gemini.config.json`

Discord のチャンネルと使用する Gemini のモデル、内部的なプロンプトを対応づけるファイルです。`"geminiChannel"`というキーの値はオブジェクトの配列になっています。以下の表を参考に、オブジェクトのキーに対応する値を入れてください。

| キー         | 値                                                                                                        |
| :----------- | :-------------------------------------------------------------------------------------------------------- |
| channelId    | Discord のチャンネル ID を設定する項目です。以下の設定はこのチャンネル内で有効になります。                |
| model        | Gemini のモデルを指定します。（例: `"gemini-2.5-flash"`）                                                 |
| systemPrompt | 送信されたメッセージの前に付与されるプロンプトです。（例: `"入力に対して日本語で回答してください。"`）    |
| config.tools | Gemini が使用できるツールを配列形式で指定します。（例: `[{ "urlContext": {} }, { "googleSearch": {} }]`） |

#### `textlint.config.json`

textlint で校正を行うチャンネルとどのプリセットで校正するかを対応づけるファイルです。`"lintChannels"`というキーの値はオブジェクトの配列になっています。以下の表を参考に、オブジェクトのキーに対応する値を入れてください。

| キー      | 値                                                                                                                                                                                                 |
| :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| channelId | Discord のチャンネル ID を設定する項目です。以下の設定はこのチャンネル内で有効になります。                                                                                                         |
| preset    | 使用する textlint のプリセットを指定します。`textlint-configs/`ディレクトリ内に`<presetの値>.textlintrc.json`というファイルが存在している必要があります。（例: `"textlint-rule-preset-japanese"`） |

### スラッシュコマンドのデプロイ

使用できるスラッシュコマンドをサーバーにデプロイするコマンドです。
以下のコマンドを実行して、デプロイしてください。

※ 1 度実行すれば OK です。

```bash
pnpm run deploy-commands
```

> ちなみにスラッシュコマンドは`commands/utility/`ディレクトリに入っている JavaScript のファイルが 1 つ 1 つのコマンドを定義しています。

### プログラムの起動

以下のコマンドで起動することができます。

```bash
pnpm run start
```

> 停止する際は`Ctrl + c`です

ちなみに Discord の仕様上、このプログラムが起動していないと Bot はメッセージを返答してくれません。そのためこの Bot をいつでも使えるようにするなら、どこかで永続的に動かしておく必要があります。

> 永続的に動かすなら [pm2](https://pm2.keymetrics.io/) などのツールを使用すること推奨。

pm2 で起動するなら以下のコマンドで起動できます。

```bash
pm2 start "pnpm run start" --name "hitsuji"
```

> `--name` オプションは任意ですが、`pm2 restart` などを行う際に名前で指定できるメリットがあるので指定しておくとよいでしょう。

> pm2 で起動した場合は`pm2 stop <ID or 指定した名前>`で停止できます。
